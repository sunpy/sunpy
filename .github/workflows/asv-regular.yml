name: asv-benchmarks-daily

permissions: "read-all"

on:
  # Allow manual runs through the web UI
  workflow_dispatch:
  schedule:
    #        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€ minute (0 - 59)
    #        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€ hour (0 - 23)
    #        â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€ day of the month (1 - 31)
    #        â”‚  â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€ month (1 - 12 or JAN-DEC)
    #        â”‚  â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€ day of the week (0 - 6 or SUN-SAT)
    - cron: "37 3 * * *" # Every day at 3:37am UTC

jobs:
  asv-run:
    if: ${{ github.repository == 'sunpy/sunpy' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sunpy repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: "0"
      - name: Checkout sunpy-benchmarks repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          repository: sunpy/sunpy-benchmarks
          ref: main
          path: asv_results
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          architecture: "x64"
      - name: Install dependencies
        run: |
          sudo apt-get install -y libopencv-dev
          python -m pip install --upgrade pip
          pip install asv virtualenv
      - name: Add machine info for ASV
        run: asv machine --machine GH-Actions --os ubuntu-latest --arch x64 --cpu "2-core unknown" --ram 7GB
      - name: Run benchmarks for commits since v2.1
        run: taskset -c 0 asv run --skip-existing-successful --steps 50 v3.0.dev..
      - name: Install SSH Client ðŸ”‘
        uses: webfactory/ssh-agent@a6f90b1f127823b31d4d4a8d96047790581349bd  # v0.9.1
        with:
          ssh-private-key: ${{ secrets.ASV_CI_KEY }}
      - name: Push results
        uses: JamesIves/github-pages-deploy-action@6c2d9db40f9296374acc17b90404b6e8864128c8  # v4.7.3
        with:
          branch: main
          folder: asv_results
          repository-name: sunpy/sunpy-benchmarks
          ssh-key: true
          commit-message: |
            Push new results from GitHub Actions
            repository: ${{ github.repository }}
            workflow: ${{ github.workflow }}
            triggered by: ${{ github.sha }}
