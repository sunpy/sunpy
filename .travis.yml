language: python

python:
  - 2.7

# Configure the build environment. Global varibles are defined for all
# configurations. Each configuration in the matrix is run for each python version
# above.
env:
    global:
        - TEST_MODE='offline'
        - LATEST_NUMPY=1.9.1
        - LATEST_PANDAS=0.15.2
        - NUMPY_VERSION=$LATEST_NUMPY
        - PANDAS_VERSION=$LATEST_PANDAS
matrix:
    include:
         - os: linux
           python: 2.7
           env: NUMPY_VERSION=1.8.1
         - os: linux
           python: 2.7
           env: PANDAS_VERSION=0.14.1
         - os: linux
           python: 2.7
           env: TEST_MODE='astropy-dev'
         - os: linux
           python: 2.7
           env: TEST_MODE='sphinx'
         - os: linux
           python: 2.7
           env: TEST_MODE='online'

    allow_failures:
        - env: TEST_MODE='online'

before_install:
    - if [[ $TRAVIS_OS_NAME == 'linux' ]] ;then source continuous-integration/travis/install_linux.sh; fi
    - if [[ $TRAVIS_OS_NAME == 'osx' ]]; then source continuous-integration/travis/install_osx.sh; fi
# Install more upto date openjpeg library.
    - wget http://openjpeg.googlecode.com/files/openjpeg-1.5.0-Linux-x86_64.tar.gz
    - sudo tar -xvf openjpeg-1.5.0-Linux-x86_64.tar.gz --strip-components=1 -C /

# Install all SunPy dependacies using wheels.
install:
    # Add a conda env and set up extra binstar channels
    - conda create --yes -n test python=$TRAVIS_PYTHON_VERSION
    - conda config --add channels sunpy astropy-ci-extras
    - source activate test
    # Install default dependancies
    - conda install -q --yes numpy scipy astropy matplotlib pandas requests beautiful-soup sqlalchemy scikit-image pytest
    - pip install pytest-cov pytest-xdist coveralls
    # Install sunpy conda packages
    - conda install suds-jurko glymur
    # Install the correct version of astropy
    - if [[ $TEST_MODE != 'astropy-dev' ]]; then conda install astropy>=0.4.0; fi 
    - if [[ $TEST_MODE == 'astropy-dev' ]]; then pip install git+git://github.com/astropy/astropy.git; fi 
    # Install sphinx if needed
    - if [[ $TEST_MODE == 'sphinx' ]]; then conda install sphinx; fi 

script:
    - if [[ $TEST_MODE == 'sphinx' ]]; then python setup.py build_sphinx -w; fi
    - if [[ $TEST_MODE == 'offline' || $TEST_MODE == 'astropy-dev' ]]; then python setup.py test --coverage --cov-report=html --offline-only; fi
    - if [[ $TEST_MODE == 'online' ]]; then python setup.py test --coverage --cov-report=term-missing --parallel=8; fi

after_success:
   - if [[ $TEST_MODE == 'online' ]]; then coveralls; fi

# Notify the IRC channel of build status
notifications:
  irc: "chat.freenode.net#SunPy"
  webhooks:
    urls:
      - https://webhooks.gitter.im/e/d1bf84e1bc1293e4dbc5
